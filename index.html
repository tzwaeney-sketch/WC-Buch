<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>WC G√§stebuch ‚Äì Familie Albrecht</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#070b14; --bg1:#0b1220;
      --card: rgba(255,255,255,.07);
      --card2: rgba(255,255,255,.04);
      --line: rgba(255,255,255,.10);
      --line2: rgba(255,255,255,.14);
      --text: #eef2ff;
      --muted: rgba(238,242,255,.70);
      --muted2: rgba(238,242,255,.52);
      --accent: #22c55e;
      --accent2:#38bdf8;
      --danger:#ef4444;
      --warn:#f59e0b;
      --shadow: 0 18px 55px rgba(0,0,0,.45);
      --shadow2: 0 10px 30px rgba(0,0,0,.25);
      --r: 26px;
      --r2: 18px;
      --safeTop: env(safe-area-inset-top);
      --safeBottom: env(safe-area-inset-bottom);
      --max: 980px;
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: Manrope, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--text);
      background:
        radial-gradient(900px 520px at 15% 0%, rgba(34,197,94,.20), transparent 56%),
        radial-gradient(900px 520px at 85% 0%, rgba(56,189,248,.18), transparent 54%),
        radial-gradient(1200px 650px at 50% 110%, rgba(139,92,246,.16), transparent 62%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      -webkit-tap-highlight-color: transparent;
      overflow-x:hidden;
    }
    a{ color:inherit; text-decoration:none; }
    button, input, textarea{ font:inherit; }

    .wrap{
      max-width: var(--max);
      margin:0 auto;
      padding: calc(14px + var(--safeTop)) 14px calc(112px + var(--safeBottom));
    }

    /* HERO */
    .hero{
      position:relative;
      border: 1px solid var(--line);
      border-radius: calc(var(--r) + 8px);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .heroGlow{
      position:absolute;
      inset:-180px -80px auto -80px;
      height: 320px;
      background: radial-gradient(closest-side, rgba(255,255,255,.11), transparent 70%);
      pointer-events:none;
      filter: blur(2px);
    }
    .heroWave{
      position:absolute;
      left:-10%;
      right:-10%;
      bottom:-34px;
      height: 90px;
      background:
        radial-gradient(140px 45px at 20% 20%, rgba(34,197,94,.25), transparent 65%),
        radial-gradient(160px 48px at 75% 70%, rgba(56,189,248,.22), transparent 65%);
      opacity:.8;
      pointer-events:none;
      filter: blur(16px);
    }
    .heroInner{ padding: 16px; position:relative; }
    .heroTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 260px;
    }
    .logoBox{
      width: 72px;
      height: 72px;
      border-radius: 24px;
      border: 1px solid rgba(255,255,255,.15);
      background:
        radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.16), transparent 70%),
        linear-gradient(135deg, rgba(34,197,94,.20), rgba(56,189,248,.12));
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: var(--shadow2);
      overflow:hidden;
      flex:0 0 auto;
    }
    .logoBox img{
      width: 88%;
      height: 88%;
      object-fit: contain;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.35));
    }
    .brandText{ display:flex; flex-direction:column; gap:2px; }
    .title{
      font-size: 20px;
      font-weight: 950;
      letter-spacing:.2px;
      line-height:1.1;
      margin:0;
    }
    .subtitle{
      margin:0;
      color: var(--muted);
      font-size: 13px;
      line-height:1.35;
      max-width: 640px;
    }
    .pills{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 9px 12px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      font-size: 13px;
      user-select:none;
    }
    .pillBtn{ cursor:pointer; }
    .dot{ width:10px; height:10px; border-radius:99px; background: var(--danger); }
    .dot.ok{ background: var(--accent); }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 1.12fr .88fr;
      gap: 14px;
      margin-top: 14px;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius: var(--r);
      box-shadow: 0 16px 45px rgba(0,0,0,.30);
      overflow:hidden;
    }
    .cardHead{
      padding: 14px 14px 0;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .cardTitle{
      margin:0;
      font-size: 15px;
      font-weight: 950;
      letter-spacing:.2px;
    }
    .cardSub{
      margin: 4px 0 0;
      font-size: 12px;
      color: var(--muted2);
      line-height: 1.35;
    }
    .cardBody{ padding: 14px; }

    /* Form */
    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin: 10px 0 6px;
    }
    input[type="text"], textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
    }
    textarea{ min-height: 96px; resize: vertical; }
    input::placeholder, textarea::placeholder{ color: rgba(238,242,255,.38); }

    .row{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top: 10px;
    }

    .btn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 12px 14px;
      border-radius: 18px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      flex: 1 1 160px;
      user-select:none;
      box-shadow: 0 10px 25px rgba(0,0,0,.18);
    }
    .btn:active{ transform: translateY(1px); }
    .btnPrimary{
      border-color: rgba(34,197,94,.30);
      background: linear-gradient(135deg, rgba(34,197,94,.22), rgba(56,189,248,.14));
    }
    .btnGhost{ background: rgba(0,0,0,.18); }
    .btnSmall{
      flex: 0 0 auto;
      padding: 9px 12px;
      border-radius: 999px;
      font-size: 13px;
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    .msg{
      display:none;
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      font-size: 13px;
      color: var(--muted);
      line-height: 1.35;
    }
    .msg.ok{ display:block; border-color: rgba(34,197,94,.30); background: rgba(34,197,94,.10); color: #d1fae5; }
    .msg.warn{ display:block; border-color: rgba(245,158,11,.30); background: rgba(245,158,11,.10); color: #ffedd5; }
    .msg.err{ display:block; border-color: rgba(239,68,68,.30); background: rgba(239,68,68,.10); color: #fee2e2; }

    /* Wizard / Steps */
    .wizard{
      margin-top: 12px;
      border-top: 1px solid rgba(255,255,255,.08);
      padding-top: 12px;
    }
    .stepBar{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .stepPill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 9px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      color: rgba(238,242,255,.78);
      user-select:none;
      font-size: 13px;
    }
    .stepPill.on{
      border-color: rgba(34,197,94,.30);
      background: linear-gradient(135deg, rgba(34,197,94,.16), rgba(56,189,248,.10));
      color: rgba(238,242,255,.92);
    }
    .stepPill .n{
      width: 26px; height:26px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      display:flex; align-items:center; justify-content:center;
      font-weight: 900; font-size: 12px;
    }
    .panel{
      margin-top: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      border-radius: 22px;
      padding: 12px;
      display:none;
    }
    .panel.on{ display:block; }
    .panelTitle{
      margin:0 0 6px;
      font-size: 14px;
      font-weight: 950;
      letter-spacing:.2px;
    }
    .panelHint{
      margin:0 0 10px;
      font-size: 12px;
      color: var(--muted2);
      line-height: 1.35;
    }
    .counter{
      text-align:right;
      font-size:12px;
      color: var(--muted2);
      margin-top: 6px;
    }

    /* Photo */
    .photoBox{
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.14);
      border-radius: 20px;
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .photoTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: rgba(238,242,255,.86);
      font-size: 12px;
      user-select:none;
    }
    .photoPreview{
      width: 100%;
      aspect-ratio: 16/10;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
    }
    .photoPreview img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:none;
    }
    .photoPlaceholder{
      color: var(--muted2);
      font-size: 13px;
      padding: 12px;
      text-align:center;
      line-height:1.35;
    }
    .fileInput{
      position:absolute;
      inset:0;
      opacity:0;
      cursor:pointer;
    }

    /* Entries */
    .entries{
      list-style:none;
      padding:0;
      margin:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .entry{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 20px;
      background: rgba(0,0,0,.18);
      padding: 12px;
      display:grid;
      grid-template-columns: 56px 1fr;
      gap:10px;
      overflow:hidden;
    }
    .thumb{
      width:56px; height:56px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      display:flex;
      align-items:center;
      justify-content:center;
      color: rgba(238,242,255,.52);
      font-size: 12px;
      overflow:hidden;
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .meta{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .who{ display:flex; flex-direction:column; gap:2px; }
    .who strong{ font-size: 14px; }
    .time{ font-size: 12px; color: var(--muted2); white-space:nowrap; }
    .text{
      margin: 8px 0 0;
      white-space:pre-wrap;
      line-height:1.35;
      font-size: 14px;
      color: rgba(238,242,255,.94);
    }
    .empty{
      color: var(--muted2);
      font-size: 13px;
      padding: 4px 2px;
    }

    /* Game */
    .gameWrap{
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      overflow:hidden;
      position:relative;
    }
    .gameHud{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding: 12px 12px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .hudLeft{ display:flex; flex-direction:column; gap:2px; }
    .hudTitle{ margin:0; font-size: 14px; font-weight:950; }
    .hudSub{ margin:0; font-size: 12px; color: var(--muted2); }
    .scorePill{
      display:inline-flex; align-items:center; gap:10px;
      padding: 8px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: rgba(238,242,255,.90);
      font-size: 13px;
      user-select:none;
    }
    .gameArea{ padding: 12px; display:flex; flex-direction:column; gap:10px; }
    .tpTrack{
      height: 24px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      overflow:hidden;
      position:relative;
    }
    .tpFill{
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(34,197,94,.32), rgba(56,189,248,.26));
      transition: width 70ms linear;
    }
    .tpTarget{
      position:absolute;
      top:0; bottom:0;
      width: 8px;
      border-radius: 999px;
      background: rgba(245,158,11,.92);
      box-shadow: 0 0 0 2px rgba(0,0,0,.25);
      transform: translateX(-50%);
      opacity:.95;
    }
    .tpCard{
      border-radius: 20px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .tpLeft{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 210px;
    }
    .tpEmoji{
      width: 46px; height:46px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      display:flex; align-items:center; justify-content:center;
      font-size: 22px;
      flex:0 0 auto;
    }
    .tpText{ display:flex; flex-direction:column; gap:2px; }
    .tpText strong{ font-size: 14px; }
    .tpText span{ font-size: 12px; color: var(--muted2); }
    .tpTap{
      flex: 1 1 160px;
      padding: 13px 14px;
      border-radius: 20px;
      border:1px solid rgba(34,197,94,.30);
      background: linear-gradient(135deg, rgba(34,197,94,.22), rgba(56,189,248,.14));
      color: var(--text);
      cursor:pointer;
      user-select:none;
      box-shadow: 0 12px 30px rgba(0,0,0,.22);
    }
    .tpTap:active{ transform: translateY(1px); }
    .tpMsg{ font-size: 13px; color: var(--muted); line-height: 1.35; margin:0; }

    /* Bottom nav */
    .bottomNav{
      position: fixed;
      left:0; right:0;
      bottom: 0;
      padding: 10px 12px calc(10px + var(--safeBottom));
      background: linear-gradient(180deg, rgba(7,11,20,0), rgba(7,11,20,.78) 40%, rgba(7,11,20,.92));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: 50;
    }
    .navBar{
      max-width: var(--max);
      margin: 0 auto;
      border:1px solid rgba(255,255,255,.10);
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      box-shadow: var(--shadow);
      display:flex;
      overflow:hidden;
    }
    .navBtn{
      flex:1 1 0;
      border:0;
      background: transparent;
      color: rgba(238,242,255,.82);
      padding: 10px 10px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      user-select:none;
    }
    .navBtn strong{ font-size: 13px; font-weight: 950; letter-spacing:.2px; }
    .navBtn span{
      width: 34px; height:34px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      display:flex; align-items:center; justify-content:center;
    }
    .navBtn.active{
      color: var(--text);
      background: linear-gradient(135deg, rgba(34,197,94,.18), rgba(56,189,248,.10));
    }
    .navBtn.active span{ border-color: rgba(34,197,94,.30); }

    /* Modal */
    .modalBackdrop{
      position: fixed;
      inset:0;
      background: rgba(0,0,0,.58);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 16px 14px calc(16px + var(--safeBottom));
      z-index: 80;
    }
    .modalBackdrop.open{ display:flex; }
    .modal{
      width: min(740px, 100%);
      border-radius: 26px;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      box-shadow: 0 30px 90px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalHead{
      padding: 14px 14px 10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .modalHead h3{
      margin:0;
      font-size: 15px;
      font-weight: 950;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .modalBody{ padding: 14px; color: rgba(238,242,255,.92); }
    .rules{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin:0;
      padding:0;
      list-style:none;
    }
    .rule{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      background: rgba(0,0,0,.16);
      padding: 12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .badge{
      width: 34px; height:34px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      display:flex; align-items:center; justify-content:center;
      flex:0 0 auto;
      font-weight: 950;
    }
    .rule strong{ display:block; font-size: 14px; margin:0 0 2px; }
    .rule span{ display:block; font-size: 13px; color: var(--muted); line-height: 1.35; }
    .modalFoot{
      padding: 12px 14px;
      border-top: 1px solid rgba(255,255,255,.08);
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    .tiny{ font-size:12px; color: var(--muted2); }
    .anchor{ scroll-margin-top: 12px; }

    @media (max-width: 420px){
      .logoBox{ width:66px; height:66px; border-radius:22px; }
      .title{ font-size: 18px; }
      .entry{ grid-template-columns: 52px 1fr; }
      .thumb{ width:52px; height:52px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <section class="hero" aria-label="Kopfbereich">
      <div class="heroGlow"></div>
      <div class="heroInner">
        <div class="heroTop">
          <div class="brand">
            <div class="logoBox" aria-label="Logo">
              <img src="logo.png" alt="Logo" onerror="this.style.display='none'">
            </div>
            <div class="brandText">
              <h1 class="title">WC G√§stebuch <span style="opacity:.82;">Familie Albrecht</span></h1>
              <p class="subtitle">Kurz eintragen. Foto optional. Unten gibt‚Äôs ein Mini-Spiel, falls du Zeit schinden willst.</p>
            </div>
          </div>
          <div class="pills">
            <div class="pill" id="netPill"><span class="dot" id="netDot"></span><span id="netText">Offline</span></div>
            <div class="pill pillBtn" id="btnRulesTop" title="Klo-Regeln √∂ffnen">üìú Regeln</div>
          </div>
        </div>

        <div class="wizard">
          <div class="stepBar" aria-label="Schritte">
            <div class="stepPill on" id="s1"><span class="n">1</span> Name</div>
            <div class="stepPill" id="s2"><span class="n">2</span> Spruch</div>
            <div class="stepPill" id="s3"><span class="n">3</span> Foto</div>
            <div class="stepPill" id="s4"><span class="n">4</span> Fertig</div>
          </div>

          <div class="panel on" id="p1">
            <p class="panelTitle">Wie hei√üt du?</p>
            <p class="panelHint">Nur ein Name. Keine Diplomarbeit.</p>
            <label for="name">Name</label>
            <input id="name" type="text" autocomplete="off" placeholder="z.B. Sven" />
            <div class="row">
              <button class="btn btnPrimary" id="to2" type="button">Weiter ‚Üí</button>
              <button class="btn btnGhost" id="jumpList1" type="button">Eintr√§ge ansehen</button>
            </div>
          </div>

          <div class="panel" id="p2">
            <p class="panelTitle">Dein Spruch</p>
            <p class="panelHint">Frech, lustig, strange. Aber kein M√ºll gegen echte Menschen.</p>
            <label for="text">Spruch</label>
            <textarea id="text" placeholder="z.B. Ich war hier. Die Keramik war w√ºrdevoll."></textarea>
            <div class="counter"><span id="cnt">0</span>/220</div>
            <div class="row">
              <button class="btn btnGhost" id="back1" type="button">‚Üê Zur√ºck</button>
              <button class="btn btnPrimary" id="to3" type="button">Weiter ‚Üí</button>
            </div>
          </div>

          <div class="panel" id="p3">
            <p class="panelTitle">Foto (optional)</p>
            <p class="panelHint">Wird automatisch verkleinert, damit es schnell l√§dt.</p>

            <div class="photoBox">
              <div class="photoTop">
                <div class="chip">üì∏ Foto ausw√§hlen</div>
                <div class="chip" id="photoChip">Kein Foto</div>
              </div>

              <div class="photoPreview" id="photoPreview">
                <div class="photoPlaceholder" id="photoPlaceholder">
                  Tippe hier, um ein Foto auszuw√§hlen.<br>
                  Oder lass es einfach weg.
                </div>
                <img id="photoImg" alt="Foto Vorschau" />
                <input class="fileInput" id="photo" type="file" accept="image/jpeg,image/jpg,image/png,image/webp" />
              </div>

              <div class="row" style="margin-top:0;">
                <button class="btn btnSmall btnGhost" id="btnRemovePhoto" type="button">‚úñ Foto entfernen</button>
                <button class="btn btnSmall btnGhost" id="btnUseCam" type="button">üì∑ Kamera</button>
              </div>
            </div>

            <div class="row">
              <button class="btn btnGhost" id="back2" type="button">‚Üê Zur√ºck</button>
              <button class="btn btnPrimary" id="to4" type="button">Weiter ‚Üí</button>
            </div>
          </div>

          <div class="panel" id="p4">
            <p class="panelTitle">Bereit zum Absenden</p>
            <p class="panelHint">Wenn‚Äôs klappt, siehst du deinen Eintrag direkt unten.</p>

            <div class="row">
              <button class="btn btnGhost" id="back3" type="button">‚Üê Zur√ºck</button>
              <button class="btn btnPrimary" id="btnSend" type="button">Absenden ‚úÖ</button>
            </div>

            <div id="msg" class="msg"></div>

            <div class="row" style="margin-top:10px;">
              <button class="btn btnSmall btnGhost" id="btnReload" type="button">‚Üª Eintr√§ge neu laden</button>
              <button class="btn btnSmall btnGhost" id="btnReset" type="button">‚úçÔ∏è Neuer Eintrag</button>
            </div>
          </div>
        </div>
      </div>
      <div class="heroWave"></div>
    </section>

    <div class="grid">
      <!-- GAME -->
      <section class="card anchor" id="secGame">
        <div class="cardHead">
          <div>
            <h2 class="cardTitle">Mini-Spiel: Klopapier-Ziel</h2>
            <p class="cardSub">Tippen = abrollen. Ziel: m√∂glichst nah an die Marke, ohne dr√ºber.</p>
          </div>
          <div class="pill" title="Bestwert wird lokal gespeichert">üèÜ Best <span id="bestScore">0</span></div>
        </div>

        <div class="cardBody">
          <div class="gameWrap">
            <div class="gameHud">
              <div class="hudLeft">
                <p class="hudTitle">Zielmarke treffen</p>
                <p class="hudSub">Tap-only. Stop, wenn du mutig bist.</p>
              </div>
              <div class="scorePill">Punkte: <strong id="scoreNow">0</strong></div>
            </div>

            <div class="gameArea">
              <div class="tpTrack" aria-label="Fortschritt">
                <div class="tpFill" id="tpFill"></div>
                <div class="tpTarget" id="tpTarget" title="Ziel"></div>
              </div>

              <div class="tpCard">
                <div class="tpLeft">
                  <div class="tpEmoji" id="tpEmoji">üßª</div>
                  <div class="tpText">
                    <strong id="tpTitle">Runde 1</strong>
                    <span id="tpSub">Tippe, bis du stoppen willst.</span>
                  </div>
                </div>
                <button class="tpTap" id="tpTap">TIPPEN!</button>
              </div>

              <p class="tpMsg" id="tpMsg">Tipp: kurze schnelle Taps sind besser als einmal Vollgas.</p>

              <div class="row" style="margin-top:0;">
                <button class="btn btnSmall btnGhost" id="tpStop" type="button">‚èπ Stop</button>
                <button class="btn btnSmall btnGhost" id="tpReset" type="button">‚Üª Neue Runde</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ENTRIES -->
      <section class="card anchor" id="secEntries" style="grid-column:1/-1;">
        <div class="cardHead">
          <div>
            <h2 class="cardTitle">Letzte Eintr√§ge</h2>
            <p class="cardSub">Neueste zuerst. Mini-Foto wird direkt angezeigt.</p>
          </div>
          <div class="tiny" id="lastUpdate"></div>
        </div>
        <div class="cardBody">
          <div id="entriesEmpty" class="empty">Lade Eintr√§ge‚Ä¶</div>
          <ul class="entries" id="entries"></ul>
        </div>
      </section>
    </div>
  </div>

  <!-- Bottom Nav -->
  <div class="bottomNav" aria-label="Navigation">
    <div class="navBar">
      <button class="navBtn active" id="navEntry" type="button"><span>‚úçÔ∏è</span><strong>Eintrag</strong></button>
      <button class="navBtn" id="navRules" type="button"><span>üìú</span><strong>Regeln</strong></button>
      <button class="navBtn" id="navGame" type="button"><span>üßª</span><strong>Spiel</strong></button>
      <button class="navBtn" id="navList" type="button"><span>üìö</span><strong>Eintr√§ge</strong></button>
    </div>
  </div>

  <!-- Rules Modal -->
  <div class="modalBackdrop" id="rulesBackdrop" role="dialog" aria-modal="true" aria-label="Klo-Regeln">
    <div class="modal">
      <div class="modalHead">
        <h3>üöΩ Klo-Regeln</h3>
        <button class="btn btnSmall btnGhost" id="btnCloseRules" type="button">‚úñ</button>
      </div>

      <div class="modalBody">
        <ul class="rules">
          <li class="rule">
            <div class="badge">1</div>
            <div><strong>Deckel runter</strong><span>Damit niemand in √úberraschungen schaut.</span></div>
          </li>
          <li class="rule">
            <div class="badge">2</div>
            <div><strong>Sp√ºlen ist keine Option</strong><span>Es ist ein Muss. Immer.</span></div>
          </li>
          <li class="rule">
            <div class="badge">3</div>
            <div><strong>B√ºrste = Ehrenmitglied</strong><span>Wenn du sie brauchst: nutz sie. Wenn nicht: auch gut.</span></div>
          </li>
          <li class="rule">
            <div class="badge">4</div>
            <div><strong>H√§nde waschen</strong><span>Du bist erwachsen. Wir m√ºssen das nicht diskutieren.</span></div>
          </li>
          <li class="rule">
            <div class="badge">5</div>
            <div><strong>G√§stebuch mit Stil</strong><span>Lustig, frech, strange. Aber keine Beleidigungen.</span></div>
          </li>
        </ul>
        <p class="tiny" style="margin:12px 2px 0;">Diese Regeln werden pro Ger√§t nur einmal automatisch angezeigt.</p>
      </div>

      <div class="modalFoot">
        <button class="btn btnSmall btnGhost" type="button" id="rulesLater">Sp√§ter</button>
        <button class="btn btnSmall btnPrimary" type="button" id="rulesOk">Verstanden ‚úÖ</button>
      </div>
    </div>
  </div>

  <script>
    // ========= FIXED CONFIG (no user changes needed) =========
    const BACKEND_URL = "/.netlify/functions/wc";
    const PIN = "1234";
    const LIST_LIMIT = 50;

    const BEST_KEY = "wcgb_tp_best_v2";
    const RULES_SEEN_KEY = "wcgb_rules_seen_v2";

    // ========= Helpers =========
    const $ = (id) => document.getElementById(id);

    function setMsg(type, text){
      const box = $("msg");
      box.className = "msg " + (type || "");
      box.textContent = text || "";
      box.style.display = text ? "block" : "none";
    }

    function escapeHtml(str){
      return String(str ?? "").replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }

    function fmtTime(v){
      if (!v) return "";
      const d = new Date(v);
      if (!isNaN(d.getTime())) return d.toLocaleString("de-DE");
      return String(v);
    }

    async function readTextSafe(res){
      try{ return await res.text(); } catch { return ""; }
    }

    function tryJson(text){
      try{ return JSON.parse(text); } catch { return null; }
    }

    // Robust fetch: try JSON POST, then form POST, and for list also GET.
    async function apiCall(action, payload){
      const basePayload = {
        pin: PIN,
        action,
        ...payload
      };

      // 1) POST JSON
      try{
        const r = await fetch(BACKEND_URL, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(basePayload)
        });
        const t = await readTextSafe(r);
        const j = tryJson(t);
        if (r.ok) return j ?? { ok:true, raw:t };
      }catch(e){ /* ignore */ }

      // 2) POST form-urlencoded
      try{
        const params = new URLSearchParams();
        Object.entries(basePayload).forEach(([k,v]) => {
          if (v === undefined || v === null) return;
          params.set(k, typeof v === "string" ? v : JSON.stringify(v));
        });

        const r = await fetch(BACKEND_URL, {
          method: "POST",
          headers: { "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
          body: params.toString()
        });
        const t = await readTextSafe(r);
        const j = tryJson(t);
        if (r.ok) return j ?? { ok:true, raw:t };
      }catch(e){ /* ignore */ }

      // 3) GET only for list
      if (action === "list"){
        try{
          const url = new URL(BACKEND_URL, window.location.origin);
          url.searchParams.set("pin", PIN);
          url.searchParams.set("action", "list");
          url.searchParams.set("limit", String(payload?.limit ?? LIST_LIMIT));

          const r = await fetch(url.toString(), { method: "GET" });
          const t = await readTextSafe(r);
          const j = tryJson(t);
          if (r.ok) return j ?? { ok:true, raw:t };
        }catch(e){ /* ignore */ }
      }

      throw new Error("Backend nicht erreichbar oder API-Format passt nicht.");
    }

    // ========= Online indicator =========
    const netDot = $("netDot");
    const netText = $("netText");
    function updateNet(){
      const online = navigator.onLine;
      netDot.classList.toggle("ok", online);
      netText.textContent = online ? "Online" : "Offline";
    }
    window.addEventListener("online", updateNet);
    window.addEventListener("offline", updateNet);

    // ========= Rules modal =========
    const rulesBackdrop = $("rulesBackdrop");
    function openRules(){
      rulesBackdrop.classList.add("open");
      setActive("rules");
    }
    function closeRules(markSeen){
      rulesBackdrop.classList.remove("open");
      if (markSeen) localStorage.setItem(RULES_SEEN_KEY, "1");
    }
    $("btnRulesTop").addEventListener("click", openRules);
    $("btnCloseRules").addEventListener("click", () => closeRules(false));
    $("rulesLater").addEventListener("click", () => closeRules(false));
    $("rulesOk").addEventListener("click", () => closeRules(true));
    rulesBackdrop.addEventListener("click", (e) => {
      if (e.target === rulesBackdrop) closeRules(false);
    });

    // ========= Bottom nav =========
    function setActive(key){
      const map = { entry:"navEntry", rules:"navRules", game:"navGame", list:"navList" };
      Object.values(map).forEach(id => $(id).classList.remove("active"));
      $(map[key]).classList.add("active");
    }
    $("navEntry").addEventListener("click", () => {
      window.scrollTo({ top: 0, behavior:"smooth" });
      setActive("entry");
    });
    $("navRules").addEventListener("click", openRules);
    $("navGame").addEventListener("click", () => {
      $("secGame").scrollIntoView({ behavior:"smooth", block:"start" });
      setActive("game");
    });
    $("navList").addEventListener("click", () => {
      $("secEntries").scrollIntoView({ behavior:"smooth", block:"start" });
      setActive("list");
    });

    // ========= Wizard =========
    const steps = [
      { pill:"s1", panel:"p1" },
      { pill:"s2", panel:"p2" },
      { pill:"s3", panel:"p3" },
      { pill:"s4", panel:"p4" },
    ];
    let stepIndex = 0;

    function showStep(i){
      stepIndex = Math.max(0, Math.min(i, steps.length - 1));
      steps.forEach((s, idx) => {
        $(s.pill).classList.toggle("on", idx === stepIndex);
        $(s.panel).classList.toggle("on", idx === stepIndex);
      });
      setMsg("", "");
      // focus
      if (stepIndex === 0) setTimeout(()=> $("name").focus(), 40);
      if (stepIndex === 1) setTimeout(()=> $("text").focus(), 40);
    }

    $("to2").addEventListener("click", () => {
      const name = $("name").value.trim();
      if (!name){
        setMsg("warn", "Name fehlt.");
        return;
      }
      showStep(1);
    });
    $("back1").addEventListener("click", () => showStep(0));
    $("to3").addEventListener("click", () => {
      const text = $("text").value.trim();
      if (!text){
        setMsg("warn", "Spruch fehlt.");
        return;
      }
      showStep(2);
    });
    $("back2").addEventListener("click", () => showStep(1));
    $("to4").addEventListener("click", () => showStep(3));
    $("back3").addEventListener("click", () => showStep(2));

    $("btnReset").addEventListener("click", () => {
      $("name").value = "";
      $("text").value = "";
      setPhotoNone();
      $("cnt").textContent = "0";
      showStep(0);
    });

    $("jumpList1").addEventListener("click", async () => {
      $("secEntries").scrollIntoView({behavior:"smooth", block:"start"});
      setActive("list");
      await loadEntries(true);
    });

    // counter
    const MAX_LEN = 220;
    $("text").addEventListener("input", () => {
      let v = $("text").value;
      if (v.length > MAX_LEN) {
        $("text").value = v.slice(0, MAX_LEN);
        v = $("text").value;
      }
      $("cnt").textContent = String(v.length);
    });

    // ========= Photo =========
    const fileInput = $("photo");
    const photoImg = $("photoImg");
    const photoPlaceholder = $("photoPlaceholder");
    const photoChip = $("photoChip");
    let selectedDataUrl = ""; // compressed dataURL

    function setPhotoNone(){
      selectedDataUrl = "";
      fileInput.value = "";
      photoImg.style.display = "none";
      photoPlaceholder.style.display = "block";
      photoChip.textContent = "Kein Foto";
    }

    $("btnRemovePhoto").addEventListener("click", (e) => {
      e.preventDefault();
      setPhotoNone();
    });

    $("btnUseCam").addEventListener("click", (e) => {
      e.preventDefault();
      fileInput.setAttribute("capture", "environment");
      fileInput.click();
      setTimeout(() => fileInput.removeAttribute("capture"), 500);
    });

    fileInput.addEventListener("change", async () => {
      const file = fileInput.files?.[0] || null;
      if (!file){ setPhotoNone(); return; }

      if (!/^image\/(jpeg|jpg|png|webp)$/i.test(file.type)){
        setMsg("warn", "Nicht erlaubter Bildtyp: " + file.type);
        setPhotoNone();
        return;
      }

      photoChip.textContent = "Wird optimiert‚Ä¶";
      setMsg("", "");

      try{
        const out = await compressImageToDataUrl(file, 1600, 0.86);
        selectedDataUrl = out.dataUrl;

        photoImg.src = selectedDataUrl;
        photoImg.onload = () => {
          photoImg.style.display = "block";
          photoPlaceholder.style.display = "none";
        };

        const kb = Math.round(out.outBytes / 1024);
        photoChip.textContent = `Optimiert: ${kb} KB (${out.outW}√ó${out.outH})`;
      }catch(err){
        setMsg("err", err?.message || "Foto konnte nicht verarbeitet werden");
        setPhotoNone();
      }
    });

    function readFileAsDataUrl(file){
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = () => reject(new Error("Datei konnte nicht gelesen werden"));
        r.readAsDataURL(file);
      });
    }

    function approxDataUrlBytes(dataUrl){
      // base64 size approx
      const idx = String(dataUrl).indexOf("base64,");
      if (idx < 0) return dataUrl.length;
      const b64 = dataUrl.slice(idx + 7);
      return Math.floor(b64.length * 0.75);
    }

    async function compressImageToDataUrl(file, maxSize, quality){
      const src = await readFileAsDataUrl(file);

      const img = await new Promise((resolve, reject) => {
        const im = new Image();
        im.onload = () => resolve(im);
        im.onerror = () => reject(new Error("Foto konnte nicht geladen werden"));
        im.src = src;
      });

      const w = img.naturalWidth || img.width;
      const h = img.naturalHeight || img.height;
      if (!w || !h) throw new Error("Ung√ºltige Bildgr√∂√üe");

      const scale = Math.min(1, maxSize / Math.max(w, h));
      const outW = Math.max(1, Math.round(w * scale));
      const outH = Math.max(1, Math.round(h * scale));

      const canvas = document.createElement("canvas");
      canvas.width = outW;
      canvas.height = outH;
      const ctx = canvas.getContext("2d", { alpha: false });
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = "high";
      ctx.drawImage(img, 0, 0, outW, outH);

      let mime = "image/jpeg";
      if (/image\/webp/i.test(file.type)) mime = "image/webp";

      let q = quality;
      let dataUrl = canvas.toDataURL(mime, q);
      let outBytes = approxDataUrlBytes(dataUrl);

      for (let i=0; i<4 && outBytes > 2_600_000; i++){
        q = Math.max(0.60, q - 0.08);
        dataUrl = canvas.toDataURL(mime, q);
        outBytes = approxDataUrlBytes(dataUrl);
      }

      if (outBytes > 2_900_000){
        const scale2 = Math.min(1, 1200 / Math.max(w, h));
        const w2 = Math.max(1, Math.round(w * scale2));
        const h2 = Math.max(1, Math.round(h * scale2));
        canvas.width = w2; canvas.height = h2
;
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = "high";
        ctx.drawImage(img, 0, 0, w2, h2);
        mime = "image/jpeg";
        dataUrl = canvas.toDataURL(mime, 0.72);
        outBytes = approxDataUrlBytes(dataUrl);
        return { dataUrl, outBytes, outW: w2, outH: h2 };
      }

      return { dataUrl, outBytes, outW, outH };
    }

    // ========= Send entry =========
    const btnSend = $("btnSend");
    btnSend.addEventListener("click", async () => {
      setMsg("", "");

      if (!navigator.onLine){
        setMsg("warn", "Kein Netz. Bitte kurz WLAN anmachen und nochmal senden.");
        return;
      }

      const name = $("name").value.trim();
      const text = $("text").value.trim();

      if (!name){
        setMsg("warn", "Name fehlt.");
        showStep(0);
        return;
      }
      if (!text){
        setMsg("warn", "Spruch fehlt.");
        showStep(1);
        return;
      }

      btnSend.disabled = true;
      btnSend.textContent = "Sende‚Ä¶";

      try{
        // Backend tolerant: mehrere Feldnamen, falls deine Function so gebaut ist
        const payload = {
          name,
          text,
          message: text,
          spruch: text,
          foto: selectedDataUrl || "",
          photo: selectedDataUrl || "",
          photoDataUrl: selectedDataUrl || "",
          photoBase64: selectedDataUrl || "",
          ts: Date.now()
        };

        const res = await apiCall("add", payload);

        // Manche Backends liefern {ok:true} oder {success:true}
        const ok = !!(res?.ok ?? res?.success ?? res?.status === "ok");

        if (ok){
          setMsg("ok", "Gespeichert ‚úÖ");
          // Nach dem Senden: Liste neu laden und UI zur√ºcksetzen
          await loadEntries(true);
          // Lass Name stehen (praktisch), aber reset Spruch + Foto:
          $("text").value = "";
          $("cnt").textContent = "0";
          setPhotoNone();
          // zur√ºck zu Schritt 2 (Spruch) damit es schneller geht
          showStep(1);
        }else{
          // Fallback: zeig irgendwas aus dem Response
          const hint = res?.message || res?.error || res?.raw || "Unbekannter Fehler vom Backend.";
          setMsg("err", "Nicht gespeichert: " + hint);
        }
      }catch(err){
        setMsg("err", err?.message || "Senden fehlgeschlagen");
      }finally{
        btnSend.disabled = false;
        btnSend.textContent = "Absenden ‚úÖ";
      }
    });

    $("btnReload").addEventListener("click", async () => {
      await loadEntries(true);
    });

    // ========= Load entries =========
    async function normalizeEntries(data){
      // Erlaubt viele Formate:
      // - { entries:[...] }
      // - { data:[...] }
      // - { rows:[...] }
      // - direkt [...]
      const arr =
        (Array.isArray(data) ? data :
        Array.isArray(data?.entries) ? data.entries :
        Array.isArray(data?.data) ? data.data :
        Array.isArray(data?.rows) ? data.rows :
        Array.isArray(data?.items) ? data.items :
        []);

      // Normalisiere Felder
      return arr.map((e) => {
        const name = e?.name ?? e?.Name ?? e?.username ?? e?.who ?? "";
        const text = e?.text ?? e?.Text ?? e?.spruch ?? e?.message ?? e?.msg ?? "";
        const foto = e?.fotoURL ?? e?.fotoUrl ?? e?.photoURL ?? e?.photoUrl ?? e?.FotoURL ?? e?.FotoUrl ?? e?.foto ?? e?.photo ?? "";
        const time = e?.timestamp ?? e?.ts ?? e?.date ?? e?.created ?? e?.time ?? "";
        return { name, text, foto, time };
      }).filter(x => x.name || x.text || x.foto || x.time);
    }

    async function loadEntries(showToast){
      try{
        if (!navigator.onLine){
          $("entriesEmpty").textContent = "Offline. Eintr√§ge k√∂nnen gerade nicht geladen werden.";
          return;
        }

        const res = await apiCall("list", { limit: LIST_LIMIT });
        const entries = await normalizeEntries(res);

        const list = $("entries");
        list.innerHTML = "";

        if (!entries.length){
          $("entriesEmpty").textContent = "Noch keine Eintr√§ge da. Mach den Anfang üòÑ";
        }else{
          $("entriesEmpty").textContent = "";
        }

        entries.slice(0, LIST_LIMIT).forEach((e) => {
          const li = document.createElement("li");
          li.className = "entry";

          const thumb = document.createElement("div");
          thumb.className = "thumb";

          if (e.foto){
            const img = document.createElement("img");
            img.src = e.foto;
            img.alt = "Foto";
            img.loading = "lazy";
            img.onerror = () => {
              thumb.innerHTML = "Foto";
              thumb.style.display = "flex";
              thumb.style.alignItems = "center";
              thumb.style.justifyContent = "center";
            };
            thumb.appendChild(img);
          }else{
            thumb.textContent = "‚Äî";
          }

          const right = document.createElement("div");

          right.innerHTML = `
            <div class="meta">
              <div class="who">
                <strong>${escapeHtml(e.name || "Anonym")}</strong>
                <span class="tiny">${escapeHtml(e.text ? "" : " ")}</span>
              </div>
              <div class="time">${escapeHtml(fmtTime(e.time))}</div>
            </div>
            <div class="text">${escapeHtml(e.text || "")}</div>
          `;

          li.appendChild(thumb);
          li.appendChild(right);
          list.appendChild(li);
        });

        $("lastUpdate").textContent = "Aktualisiert: " + new Date().toLocaleTimeString("de-DE");

        if (showToast) setMsg("ok", "Eintr√§ge aktualisiert ‚úÖ");
      }catch(err){
        $("entriesEmpty").textContent = "Fehler beim Laden.";
        if (showToast) setMsg("err", err?.message || "Eintr√§ge konnten nicht geladen werden");
      }
    }

    // ========= Mini game =========
    let target = 0.72;      // 0..1
    let fill = 0.0;         // 0..1
    let running = true;
    let round = 1;
    let score = 0;

    const tpFill = $("tpFill");
    const tpTarget = $("tpTarget");
    const scoreNow = $("scoreNow");
    const bestScore = $("bestScore");

    function loadBest(){
      const v = Number(localStorage.getItem(BEST_KEY) || "0");
      bestScore.textContent = String(isFinite(v) ? v : 0);
    }
    function saveBest(v){
      localStorage.setItem(BEST_KEY, String(v));
      loadBest();
    }

    function newRound(){
      fill = 0;
      running = true;
      target = 0.25 + Math.random() * 0.65;
      round++;
      $("tpTitle").textContent = "Runde " + round;
      $("tpSub").textContent = "Tippe, bis du stoppen willst.";
      $("tpMsg").textContent = "Ziel: m√∂glichst nah an die Marke, ohne dr√ºber.";
      renderGame();
    }

    function renderGame(){
      tpFill.style.width = Math.max(0, Math.min(1, fill)) * 100 + "%";
      tpTarget.style.left = (Math.max(0, Math.min(1, target)) * 100) + "%";
      scoreNow.textContent = String(score);
    }

    function stopRound(){
      if (!running) return;
      running = false;

      const diff = target - fill;
      let points = 0;

      if (diff >= 0){
        // n√§her = mehr Punkte
        points = Math.max(0, Math.round(1000 * (1 - diff)));
        $("tpMsg").textContent = `Sauber. Abstand: ${(diff*100).toFixed(1)}% ‚Üí +${points} Punkte`;
      }else{
        // dr√ºber = 0 und Spott
        points = 0;
        $("tpMsg").textContent = `Uff‚Ä¶ dr√ºber: ${Math.abs(diff*100).toFixed(1)}%. Keramik weint. +0 Punkte`;
      }

      score += points;

      const best = Number(localStorage.getItem(BEST_KEY) || "0");
      if (score > best) saveBest(score);

      $("tpSub").textContent = "Stop gedr√ºckt. Neue Runde?";
      renderGame();
    }

    // Tap increases fill by a small random amount
    $("tpTap").addEventListener("click", () => {
      if (!running) return;
      const add = 0.018 + Math.random() * 0.030; // feel-good
      fill = Math.min(1.05, fill + add);
      renderGame();
      if (fill >= 1){
        // auto stop if full
        stopRound();
      }
    });

    $("tpStop").addEventListener("click", stopRound);

    $("tpReset").addEventListener("click", () => {
      score = 0;
      round = 0;
      newRound();
      renderGame();
    });

    // ========= Init =========
    function init(){
      updateNet();
      loadBest();
      renderGame();
      newRound();
      showStep(0);

      // rules once
      if (!localStorage.getItem(RULES_SEEN_KEY)){
        setTimeout(() => rulesBackdrop.classList.add("open"), 450);
      }

      // initial load
      loadEntries(false);
    }

    init();
  </script>
</body>
</html>
